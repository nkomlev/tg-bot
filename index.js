require('dotenv').config();
const TelegramBot = require('node-telegram-bot-api');

const token = process.env.API_TOKEN;

const bot = new TelegramBot(token, { polling: true });
const userStates = {}

bot.on('polling_error', (error) => {
  console.error('–ü–æ–ª–Ω–∞—è –æ—à–∏–±–∫–∞ Polling:', error);
});

bot.onText(/\/start/, (msg) => {
  const chatId = msg.chat.id;
  const welcomeText = '–ß—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å —Å–≤–æ–π –ø–æ–¥–∞—Ä–æ–∫ üéÅ, —Ç–µ–±–µ –Ω—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Å–ª–µ–¥—É—é—â–µ–µ –∏—Å–ø—ã—Ç–∞–Ω–∏–µ:\n' +
    'üíÉ –°—Ç–∞–Ω—Ü—É–π —Ç–∞–Ω–µ—Ü –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ Likee ‚Äî –ø–æ–¥ —Å–≤–æ–π –ª—é–±–∏–º—ã–π —Ç—Ä–µ–∫ –∏–ª–∏ –≤—ã–±–µ—Ä–∏ —Å–∞–º—ã–π –ø–æ–ø—É–ª—è—Ä–Ω—ã–π —Ç–∞–Ω–µ—Ü.\n' +
    'üì≤ –ó–∞–ø–∏—à–∏ –≤–∏–¥–µ–æ –∏ –æ—Ç–ø—Ä–∞–≤—å –µ–≥–æ —Å—é–¥–∞, –≤ –±–æ—Ç–∞.\n' +
    '–ö–æ–≥–¥–∞ –∑–∞–¥–∞–Ω–∏–µ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–æ, –ø–æ–¥–∞—Ä–æ–∫ —Å—Ç–∞–Ω–µ—Ç —Ç–≤–æ–∏–º! ‚ú®\n';

  userStates[chatId] = 'waiting_for_video';

  bot.sendMessage(chatId, welcomeText);
});

bot.on('message', async (msg) => {
  const chatId = msg.chat.id;
  const currentState = userStates[chatId];

  if (currentState === 'waiting_for_video') {
    if (msg.video || msg.document && msg.document.mime_type?.includes('video')) {
      bot.sendMessage(chatId, 'ü§î–¢–∞–∞–∫—Å, –¥–∞–π-–∫–∞ –º–Ω–µ –ø–∞—Ä—É —Å–µ–∫—É–Ω–¥ –ø–æ–ª—É—á—à–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å üëÄ');
      setTimeout(() => {
        const secondMessage = 'üåü –£—Ä–∞,–†–∏—Ç–∞! üåü\n' +
          '–¢—ã —Å–ø—Ä–∞–≤–∏–ª–∞—Å—å —Å –ø–µ—Ä–≤—ã–º –∑–∞–¥–∞–Ω–∏–µ–º ‚Äî —ç—Ç–æ –±—ã–ª–æ –∫—Ä—É—Ç–æ! üíÉüî•\n' +
          '–ù–æ –≤–µ–¥—å —Ç—ã –Ω–µ –¥—É–º–∞–ª–∞, —á—Ç–æ –≤—Å—ë –±—É–¥–µ—Ç —Ç–∞–∫ –ø—Ä–æ—Å—Ç–æ? üòâ\n' +
          '–≠—Ç–æ —Ç–æ–ª—å–∫–æ –Ω–∞—á–∞–ª–æ üéØ\n' +
          '–ó–∞ —Ç–≤–æ—ë —Å—Ç–∞—Ä–∞–Ω–∏–µ —Ç—ã –ø–æ–ª—É—á–∞–µ—à—å üéÅ —Å–≤–æ–π —Å—Ç–∏–∫–µ—Ä–ø–∞–∫ ‚Äî –æ–Ω–ª–∞–π–Ω –∏ –æ—Ñ–ª–∞–π–Ω!\n' +
          '–ù–∞–∂–º–∏ <a href="https://t.me/addstickers/stickeRitaaa">—Å—é–¥–∞</a>, —á—Ç–æ–±—ã –∑–∞–±—Ä–∞—Ç—å –µ–≥–æüòä\n\n' +
          '–ê —á—Ç–æ–±—ã –ø–µ—Ä–µ–π—Ç–∏ –∫–æ –≤—Ç–æ—Ä–æ–º—É –∑–∞–¥–∞–Ω–∏—é, –Ω–∞–∂–º–∏ –Ω–∞ üíó\n';

        const opts = {
          parse_mode: 'HTML',
          reply_markup: {
            keyboard: [
              [ { text: 'üíó' } ],
            ],
            resize_keyboard: true,
            one_time_keyboard: true
          }
        };
        bot.sendMessage(chatId, secondMessage, opts);
        userStates[chatId] = 'second_task';
      }, 3000);

    } else {
      // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–∏–ª —á—Ç–æ-—Ç–æ –¥—Ä—É–≥–æ–µ (—Ç–µ–∫—Å—Ç, —Ñ–æ—Ç–æ, –∞—É–¥–∏–æ)
      bot.sendMessage(chatId, 'ü§ó–ú–Ω–µ –≤—Å–µ–≥–¥–∞ –ø—Ä–∏—è—Ç–Ω–æ —Å —Ç–æ–±–æ–π –ø–æ–æ–±—â–∞—Ç—å—Å—è, –Ω–æ —Å–µ–π—á–∞—Å —è –∂–¥—É –æ—Ç —Ç–µ–±—è –∏–º–µ–Ω–Ω–æ –≤–∏–¥–µ–æ. –ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑ üëÄ');
    }
  } else if (currentState === 'second_task') {
    if (msg.text === 'üíó') {
      const thirdMessage = 'üíó –†–∏—Ç–∞, –≤–ø–µ—Ä–µ–¥–∏ —Ç–µ–±—è –∂–¥—ë—Ç –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω–æ–µ, –Ω–æ –Ω–µ –º–µ–Ω–µ–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ! üéØ\n' +
        'üîé –ì–¥–µ-—Ç–æ –¥–æ–º–∞ —Å–ø—Ä—è—Ç–∞–Ω—ã 6 –∫–æ—Ä–æ–±–æ–∫. –í –∫–∞–∂–¥–æ–π –∏–∑ –Ω–∏—Ö –ª–µ–∂–∏—Ç –ø—Ä–µ–¥–º–µ—Ç.\n' +
        '–¢–≤–æ—è –∑–∞–¥–∞—á–∞: —Å –∑–∞–∫—Ä—ã—Ç—ã–º–∏ –≥–ª–∞–∑–∞–º–∏ üëÄ —É–≥–∞–¥–∞—Ç—å, —á—Ç–æ —ç—Ç–æ –∑–∞ –ø—Ä–µ–¥–º–µ—Ç.\n' +
        '–ö–æ–≥–¥–∞ —Ç—ã —É–≥–∞–¥–∞–µ—à—å, –≤ –∫–æ—Ä–æ–±–∫–µ —Ç–µ–±—è –±—É–¥–µ—Ç –∂–¥–∞—Ç—å —á–∞—Å—Ç—å –ø–∞–∑–ª–∞ üß©.\n' +
        '–°–æ–±–µ—Ä–∏ –≤—Å–µ —á–∞—Å—Ç–∏ –≤–æ–µ–¥–∏–Ω–æ ‚Äî –∏ —Ç–æ–≥–¥–∞ –æ–Ω–∏ –ø—Ä–∏–≤–µ–¥—É—Ç —Ç–µ–±—è –∫ —Ç–≤–æ–µ–º—É –Ω–∞—Å—Ç–æ—è—â–µ–º—É –ø–æ–¥–∞—Ä–∫—É –Ω–∞ –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è üéÅ‚ú®\n' +
        'üå∏–ù–æ —Å–Ω–∞—á–∞–ª–∞ —Ç–µ–±–µ –Ω—É–∂–Ω–æ –Ω–∞–π—Ç–∏ —ç—Ç–∏ —Å–∞–º—ã–µ –∫–æ—Ä–æ–±–∫–∏.\n' +
        '\n' +
        '\n' +
        ' –ê –¥–ª—è —ç—Ç–æ–≥–æ ‚Äî –æ—á–∞—Ä—É–π —Å–≤–æ–∏—Ö —Ä–æ–¥–∏—Ç–µ–ª–µ–π üíï, –∏ –æ–Ω–∏ –¥–∞–¥—É—Ç —Ç–µ–±–µ –ø–æ–¥—Å–∫–∞–∑–∫—É, –≥–¥–µ –∏—Å–∫–∞—Ç—å!\n';

      bot.sendMessage(chatId, thirdMessage, {
        reply_markup: {
          remove_keyboard: true
        }
      });
      userStates[chatId] = 'karaoke';

      // setTimeout(() => {
      //   const message = '–ß—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –Ω–∞–∂–º–∏ –Ω–∞ –±–µ–ª–æ–µ —Å–µ—Ä–¥—Ü–µ';
      //   const opts = {
      //     reply_markup: {
      //       keyboard: [
      //         [ { text: 'ü§ç' } ],
      //       ],
      //       resize_keyboard: true,
      //       one_time_keyboard: true,
      //       disable_notification: true
      //     }
      //   };
      //   bot.sendMessage(chatId, message, opts);
      // }, 10000);
    }
  } else if (currentState === 'karaoke') {
    if (msg.text.toLowerCase() === '—è —Ö–æ—á—É —Å–ø–µ—Ç—å –ø–µ—Å–Ω—é') {
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å "–∑–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ"
      await bot.sendChatAction(chatId, 'upload_video');

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤–∏–¥–µ–æ
      const sentVideo = await bot.sendVideo(
        chatId,
        './Rita.mp4',
        {
          caption: 'üé¨ –û-–æ-–æ, –∞ —è –∫–∞–∫ —Ä–∞–∑ –ø–æ–¥–≥–æ—Ç–æ–≤–∏–ª –¥–ª—è —Ç–µ–±—è –ø–µ—Å–Ω—é üé∂\n' +
            '–°–ø–æ—ë—à—å –µ—ë –¥–ª—è –Ω–∞—Å? üé§‚ú®',
          parse_mode: 'HTML',
          duration: 224,
          width: 1920,
          height: 1080,
          supports_streaming: true // —Ä–∞–∑—Ä–µ—à–∞–µ—Ç –ø–æ—Ç–æ–∫–æ–≤–æ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
        }
      );
      userStates[chatId] = 'voice';
    }
  } else if (currentState === 'voice') {
    if (msg.text === 'ü§ç') {
      const message = '–£—Ö —Ç—ã –∫–∞–∫–æ–π —É–¥–∏–≤–∏—Ç–µ–ª—å–Ω—ã–π —É —Ç–µ–±—è –ø–æ–¥–∞—Ä–æ–∫! –ê –º–æ–∂–µ—à—å, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏ –¥–ª—è –º–µ–Ω—è —á—Ç–æ-–Ω–∏–±—É–¥—å —Å—ã–≥—Ä–∞—Ç—å?ü•π';
      bot.sendMessage(chatId, message);
    } else if (msg.voice && msg.voice.duration > 0) {
      const message = 'üåü –†–∏—Ç–∞, —Ç—ã –±–æ–ª—å—à–∞—è –º–æ–ª–æ–¥–µ—Ü! üåü\n' +
        '–¢—ã —Å–æ–≥–ª–∞—Å–∏–ª–∞—Å—å –Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ, —Ö–æ—Ç—è —É–∂–µ —Ä–∞–∑–≥–∞–¥–∞–ª–∞ —Å—Ç–æ–ª—å–∫–æ –∑–∞–≥–∞–¥–æ–∫ –∏ –ø—Ä–æ—à–ª–∞ —Å—Ç–æ–ª—å–∫–æ –∏—Å–ø—ã—Ç–∞–Ω–∏–π üéØ‚ú®\n' +
        '–ù–æ —ç—Ç–æ –±—É–¥–µ—Ç —á—É—Ç—å –ø—Ä–æ—â–µ: —Ç–µ–±–µ –æ—Å—Ç–∞–ª–æ—Å—å –≤—Å–µ–≥–æ –ª–∏—à—å –ø—Ä–æ—Å–ª—É—à–∞—Ç—å –ø–µ—Å–Ω—é üé∂ –∏ –ø–æ–Ω—è—Ç—å, –æ –∫–∞–∫–æ–º –º–µ—Å—Ç–µ –∏–¥–µ—Ç —Ä–µ—á—å üéÅ\n' +
        '–Ø –≤–µ—Ä—é, —á—Ç–æ —ç—Ç–æ —Å—Ç–æ–∏—Ç —Ç–≤–æ–∏—Ö —Å—Ç–∞—Ä–∞–Ω–∏–π üíñ\n' +
        '–°–ø–∞—Å–∏–±–æ, —á—Ç–æ –∏–≥—Ä–∞–ª–∞ –∏ –±—ã–ª–∞ —Ç–∞–∫–æ–π —Å–º–µ–ª–æ–π –∏ –Ω–∞—Ö–æ–¥—á–∏–≤–æ–π!\n' +
        '–î–æ –Ω–æ–≤—ã—Ö –≤—Å—Ç—Ä–µ—á! üå∏üëã\n';
      bot.sendMessage(chatId, message);

      try {
        await bot.sendChatAction(chatId, 'upload_voice');
        const sentAudio = await bot.sendAudio(
          chatId,
          './Rita_Birthday.mp3',
          {
            caption: '',
            parse_mode: 'HTML',
            title: '–°–µ–∫—Ä–µ—Ç–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞',
            performer: '–î–µ–Ω—å –†–æ–∂–¥–µ–Ω–∏—è –†–∏—Ç—ã',
            duration: 135,
          }
        );
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞—É–¥–∏–æ:', error);
      }

      userStates[chatId] = null;
    } else {
      bot.sendMessage(chatId, 'ü§ó–û—Ç–ø—Ä–∞–≤—å –º–Ω–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —á—Ç–æ–±—ã —è –º–æ–≥ –Ω–∞—Å–ª–∞–¥–∏—Ç—å—Å—è –∏–≥—Ä–æ–π)');
    }
  }
});

// –í—ã–≤–æ–¥–∏–º –≤ –∫–æ–Ω—Å–æ–ª—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º –∑–∞–ø—É—Å–∫–µ
console.log('–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –Ω–∞—á–∞–ª –æ–ø—Ä–∞—à–∏–≤–∞—Ç—å —Å–µ—Ä–≤–µ—Ä—ã Telegram...');